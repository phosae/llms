<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASM Fix Test</title>
</head>
<body>
    <h1>WASM Fix Test</h1>
    <div id="status">Loading...</div>
    <div id="results"></div>
    
    <script src="wasm_exec.js"></script>
    <script>
        class TestFix {
            constructor() {
                this.wasmLoaded = false;
                this.loadWasm();
            }
            
            async loadWasm() {
                try {
                    const go = new Go();
                    
                    // Handle WASM ready message
                    const messageHandler = (event) => {
                        if (event.data && event.data.type === 'wasmReady') {
                            console.log('WASM ready message received:', event.data);
                            window.removeEventListener('message', messageHandler);
                            this.wasmLoaded = true;
                            document.getElementById('status').textContent = 'WASM loaded successfully!';
                            this.testFunctions();
                        }
                    };
                    
                    window.addEventListener('message', messageHandler);
                    
                    console.log('Loading WASM module...');
                    const result = await WebAssembly.instantiateStreaming(fetch('llm-transformers.wasm'), go.importObject);
                    console.log('WASM instantiated, running Go program...');
                    go.run(result.instance);
                    
                } catch (error) {
                    console.error('WASM loading error:', error);
                    document.getElementById('status').textContent = 'WASM failed to load: ' + error.message;
                }
            }
            
            testFunctions() {
                const results = document.getElementById('results');
                
                try {
                    console.log('Testing getAvailableTransformations (the problematic function)...');
                    const transformations = getAvailableTransformations();
                    console.log('Transformations result:', transformations);
                    results.innerHTML += '<p><strong>‚úÖ getAvailableTransformations SUCCESS:</strong> ' + JSON.stringify(transformations, null, 2) + '</p>';
                    
                    console.log('Testing getSupportedProviders...');
                    const providers = getSupportedProviders();
                    console.log('Providers result:', providers);
                    results.innerHTML += '<p><strong>‚úÖ getSupportedProviders SUCCESS:</strong> ' + JSON.stringify(providers, null, 2) + '</p>';
                    
                    results.innerHTML += '<h2>üéâ All tests passed! WASM panic is fixed!</h2>';
                    
                } catch (error) {
                    console.error('Function test error:', error);
                    results.innerHTML += '<p><strong>‚ùå ERROR:</strong> ' + error.message + '</p>';
                }
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            new TestFix();
        });
    </script>
</body>
</html>